{% extends 'ComSemApp/sidebar.html' %}

{% block content %}

{% csrf_token %}

<!-- Page-Title -->
<div class="row">
    <div class="col-sm-12">
        <div class="page-title-box">
            <h4 class="page-title">
                Error Search
            </h4>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<!-- search criteria -->
<form class="csSpacer" method="POST" id="SubmitSearchForm">
    <input type="hidden" name="searchCriteria" id="searchCriteria" />
    <div class="row">
        <!-- left most column -->
        <div class="col-lg-4">

            <!-- Space for user to enter the first word, mandatory -->
            <div class="form-group">
                <label for="word1">Enter an Error Type</label>
                <select class="form-control" id="word1" name="word1">
                    {% for item in errors %}
                    <option value="{{ item.category }}" title="{{ item.description }}"> {{ item.category }} </option>
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-sm-12 col-md-6">
                    <h4 class="m-b-10 header-title">
                        Selector
                    </h4>
                </div>
            </div>

            <div class="row">
                <div class="col-12 nicescroll" id="DynamicField1" name="DynamicField1">
                    <p>Please enter an Error Type.</p>
                </div>
            </div>
        </div>

        <!-- middle column -->
        <div class="col-lg-4">
            <div class="form-group">
                <label for="word2">Enter an Error Sub-Category (Optional)</label>
                <select class="form-control" id="word2" name="word2">
                    <option>----------</option>
                </select>
            </div>
            <div class="row">
                <div class="col-sm-12 col-md-6">
                    <h4 class="m-b-10 header-title">
                        Selector
                    </h4>
                </div>
            </div>
            <div class="row" style="max-height: 400px; overflow-y: scroll;">
                <div class="col-12 nicescroll" id="DynamicField2" name="DynamicField2">

                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <!-- search area -->
            <br><br><br>
            <div class="row">
                <div class="col-6">
                    <!-- submit button -->
                    <button class="btn btn-sm btn-outline-success pull-right" name="searchForm" id="searchForm"
                        type="submit">
                        <span>Search <i class="ti-angle-right"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>


</form>

<!-- results -->
<br />

<div class="row">
    <div class="col-md-12">
        <div class="card-box" id="searchResults" style="display: none"></div>
    </div>
</div>


<script>
    // Holds search data that is sent to Django to determine sentences to pull 
    // from the corpus
    var searchCriteria = [];

    function collectData(id) {
        var err_data = document.getElementById(id).value;
        searchCriteria.push({ err_name: err_data });
        $('#searchCriteria').val(JSON.stringify(searchCriteria));
    }

    $(document).ready(function () {
        console.log("Page ready");
        $('select#word1').change(function () {
            var optionSelected = $(this).find("option:selected");
            var valueSelected = optionSelected.val();
            var error_name = optionSelected.text();

            data = { 'err': error_name };
            $.ajax({
                url: '{% url "corpus:get_error_sub" %}',
                type: "GET",
                data: data,
                success: function (result) {
                    removeOptions(document.getElementById('word2'));
                    for (var i = result.length - 1; i >= 0; i--) {
                        $("#word2").append('<option>' + result[i].name + '</option>');
                    };
                }
            });
        });

        $("#SubmitSearchForm").submit(function (e) {
            e.preventDefault();

            searchCriteria = [];

            $(this).prop("disabled", true);

            collectData("word1");

            if ($("#word2").val() !== "----------") {
                collectData("word2");
            } else {
                console.log("no sub-category selected");
            }

            var data = { 'searchCriteria': $('#searchCriteria').val() };
            //TODO: Alter views.py functions to fit needs of error searching
            $('#searchResults').show().html("<div class='row float-middle'>Loading...</div>").load("{% url 'corpus:error_search_results' %}", data);
            $(this).prop("disabled", false);
        });
    });

    function removeOptions(selectElement) {
        var i, L = selectElement.options.length - 1;
        for (i = L; i >= 1; i--) {
            selectElement.remove(i);
        }
    }

</script>


{% endblock %}
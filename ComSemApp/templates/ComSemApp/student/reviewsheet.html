{% extends 'ComSemApp/sidebar.html' %}

{% load static %}

{% block content %}

<div class="row">

	<div class="col-md-12 col-lg-9">
		<!-- invisible until setup is complete -->
		<div class="card-box invisible">
			<h4 class="header-title m-t-0 m-b-20">Reviewsheet</h4>

			<!-- bar displaying student's progress throughout the reviewsheet -->
			<div class="progress"  style="height: 20px;">
  				<div class="progress-bar bg-success" role="progressbar" style="height: 20px; width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
			</div>
			<input hidden type="text" id="save_attempt_url" value="{% url 'student:save_reviewsheet' course.id%}">
			<div class="card ">
				<!-- rs-container: only shown one at a time, allowing user to navigate start > show-expression > continue > ... > end -->

				<div class='rs-container card-body start'> <!--card for initial instructions-->
					<h1 class="card-title">INSTRUCTIONS</h1>
					<p class="card-text">For each expression you selected, you will be shown either a correct or incorrect formulation. You will have <strong>ten seconds</strong> per expression to provide your answer. If you do not know the answer to a question, select 'skip' to move to the next. Your results will be saved after every answer, so you may end the review at any point.</p>
				</div>

				<div class='rs-container card-body show-expression'> <!-- card for showing expression -->
					<h1 class="card-title text-center" id='timedisplay' class="card-title">00.0</h1>
					<h1 id='expression-term'  class="card-title text-center">Expression</h1>
				</div>

				<div class='rs-container card-body continue'> <!-- card that asks students if they would like to quit mid review sheet or continue-->
					<h1 class="card-title">Would you like to continue?</h1>
					<p class="card-text">Your results up to this point are automatically saved. Select <strong>EXIT</strong> to quit the review and see your results, or <strong>CONTINUE</strong> to review the next term.</p>
				</div>

				<div class='card-body end'> <!--card for displaying results-->
					<h1 class="card-title">Review complete!</h1>
                    <table id="results_table" class="table table-hover"> <!--table for displaying results of a worksheet-->
                        <thead>
                            <tr>
                                <th>Expression</th> <!--display term that students saw in question-->
                                <th>Right Answer</th> <!--displays if term is gramatically correct-->
                                <th>Your Answer</th> <!--displays if the student's answer was correct-->
                            
                            </tr>
                        </thead>
                        <tbody id="result_body">
                            <!-- Results populated here -->
                        </tbody>

                    </table>
                    
				</div>
				<div class="btn-group d-flex card-footer" role="group" aria-label="...">

					<!-- button display cycles same as rs-containers -->
					<button class='btn btn-success btn-lg w-100 start' id='begin-review'>BEGIN REVIEW</button>

					<button class="btn btn-primary btn-lg review-response w-100 show-expression" value="correct">CORRECT</button>
					<button class="btn btn-warning btn-lg review-response w-100 show-expression" value="skipped">SKIP</button>
					<button class="btn btn-danger btn-lg review-response w-100 show-expression" value="incorrect">INCORRECT</button>
					
					<button class="btn btn-danger btn-lg continue-response w-100 continue" value="quit">EXIT REVIEW</button>
					<button class="btn btn-primary btn-lg continue-response w-100 continue" value="next-expression">CONTINUE REVIEW</button>

					<a class="btn btn-success btn-lg w-100 end" id='exit-review' href="{% url 'student:course' course.id%}">RETURN TO COURSE</a>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	// AF - Sets up the screen height according to the tallest rs-container
	// 		Should be replaced with a more dynamic option!
	$('.rs-container').css("height", "auto");
	setEqualHeight($('.rs-container'));

	hide('show-expression');
	hide('continue');
	hide('end');

	$('.card-box').removeClass("invisible");

	// AF - set to 10.0 for production!
	const MAX_TIME = 1000.0;

	let review_data = {{ review_data | safe }};

	let student = "{{ student_id | safe }}";
	let course = "{{ course.id| safe }}";
	let current_container_id = 'start';
	let start_time;
	let timer; 
	let current_time = 0; // variable for current time
	let current_question; // variable for number of questions a user gets through
	let increments = [];  

	// AF - shuffle the expressions
	review_data.sort(() => Math.random() - 0.5);


	get_bar_increments();

	// AF - Get a list of points (0-100) that the progress bar will stop at as the student
	//		completes the review
	function get_bar_increments() {
		let inc = 100 / review_data.length;
		let prog = 0;
		for (let j = 0; j < review_data.length - 1; j++) {
			prog += inc;
			increments.push(prog);
		}
		increments.push(100);
	}

	// AF - Hide all elements having classname
	function hide(classname) {
		$('.' + classname).addClass("d-none");
	}

	// AF - Show all elements having classname
	function show(classname) {
		$('.' + classname).removeClass("d-none");
	}

	// AF - Use to set rs-containers to constant height, 
	//		replace this when we can
	function setEqualHeight(columns) {
		var tallestcolumn = 0;
		columns.each(function() {
			currentHeight = $(this).height();
			if (currentHeight > tallestcolumn) {
				tallestcolumn = currentHeight;
			}
		});
		columns.height(tallestcolumn);
	}
   
	// AF - initializes timer to the current time
	function start_time_interval () {
		start_time = getnow();
		timer = setInterval(update_timer, 100);
	}
	
	// AF - update timer with time since start
	function update_timer() {
		current_time = (getnow() - start_time) / 1000;
		$("#timedisplay").html(pad2(current_time.toFixed(1)));
		if (current_time >= MAX_TIME) {
			clearInterval(timer);
			post_max_time_exceeded(null);
			current_time = 0;
			// go to continue screen
			process_response();
		} 
	}

	// AF - pad out number to format as 00.0
	function pad2(number) {
    	return (number < 10 ? '0' : '') + number;
   	}

	// AF - return the current time
	function getnow() {
		return new Date().getTime();
	}

	// AF - switch current_container_id to new_container_id and
	//		hide/show rs-containers accordingly
	function change_container(new_container_id) {
		hide(current_container_id);
		show(new_container_id);
		current_container_id = new_container_id;
	};

	// AF - Initialize the reviewsheet
	function start_review() {
		i = 0;
		// Show the first expression
		console.log(review_data);
		$("#expression-term").html(review_data[i]['term']);
		change_container("show-expression");
		start_time_interval();
	}
    
    // VL - This function displays student results
    function display_results() {
        // check is displayed if a student answered correctly and x is displayed if they are incorrect or skipped
        for(i = 0; i < current_question; i++){ // displays original incorrect expression and term
            if (review_data[i]['correct'] === true){ // checks if student is correct
                // displays correct is student is correct
                $("#result_body").append(`<tr><td>${review_data[i]['term']}</td><td>${review_data[i]['answer']}</td><td><i class=" fa fa-check-circle"></i></td></tr>`); 
            } else {
                // displays incorrect if student is incorrect
                $("#result_body").append(`<tr><td>${review_data[i]['term']}</td><td>${review_data[i]['answer']}</td><td><i class="fa fa-times-circle"></i></td></tr>`);
            }
        
        }

    }

    // AF - post a ReviewAttempt if the student has exceeded MAX_TIME
	function post_max_time_exceeded(event) {
		clearInterval(timer);
		let attemptFormData = new FormData();
        review_data[i]['correct'] = false;
		attemptFormData.append( 'correct', false );
		attemptFormData.append( 'student', student );
		attemptFormData.append( 'expression', review_data[i]['id']);
		attemptFormData.append( 'response_time', MAX_TIME );
		attemptFormData.append( 'course', course);
        
		$.ajax({
			type: "POST",
			url: $("#save_attempt_url").val(),
			data: attemptFormData,
			processData: false,
			contentType: false,
			success: function(response){
				
				cs_notification('warning', "Maximum time exceeded!");
				
			},
			error: function(jqXHR, textStatus, errorThrown){
				cs_ajax_error(jqXHR, textStatus, errorThrown);
			},
		}); 
	}

	// AF - post a ReviewAttempt with response_value at time
	function post_response(event, time, response_value) {
		console.log(time);
		event.preventDefault();
		let attemptFormData = new FormData();
		let is_correct = (response_value == review_data[i]['answer']);
		review_data[i]['correct'] = is_correct;
        
		attemptFormData.append( 'correct', is_correct );
		attemptFormData.append( 'student', student );
		attemptFormData.append( 'expression', review_data[i]['id']);
		attemptFormData.append( 'response_time', time );
		attemptFormData.append( 'course', course);

		$.ajax({
			type: "POST",
			url: $("#save_attempt_url").val(),
			data: attemptFormData,
			processData: false,
			contentType: false,
			success: function(response){
				// REMOVE THIS FOR REAL VERSION!!
				cs_notification('success', "(debug) Review Attempt Recorded");
				
			},
			error: function(jqXHR, textStatus, errorThrown){
				cs_ajax_error(jqXHR, textStatus, errorThrown);
			},
		}); 
	}

	// AF - enter continue and allow user to go to next expression or choose to end early,
	//		OR end automatically if no expressions left
	function process_response() {
		$('.progress-bar').attr('aria-valuenow', increments[i]).css('width', increments[i] + "%");
		if (increments[i] === 100) {
			$('.progress-bar').removeClass("bg-success");
			$('.progress-bar').addClass("bg-primary");
		}
		i++;
		if (i >= review_data.length) {
			// If there are no more expressions, go to end
			change_container("end"); // displays results page
            display_results(); // populates results page
		} else {
			// Allow user to go on
			change_container("continue");
		}
	}

	$( document ).ready(function() {
        console.log( "document loaded" );
		// initializing review
		$("#begin-review").click( function() {
		    current_question = 1;
			start_review();
		});

		// get responses and stop the timer
		$(".review-response").mousedown( function(e) {
			clearInterval(timer);
			post_response(e, current_time, this.value);
			current_time = 0;
			// go to continue screen
			process_response();
		});

		// direct to appropriate rs-container based on continue response
		$(".continue-response").click( function() {
			if (this.value === "quit") {
			    display_results();
				change_container("end");
			} else if (this.value === "next-expression") {
				$("#expression-term").html(review_data[i]['term']);
				current_question += 1;
				change_container("show-expression");
				start_time_interval();
			}
		}); 

    });
	
</script>
{% endblock %}

{% extends 'ComSemApp/sidebar.html' %}

{% load static %}

{% block content %}

<div class="row">

	<div class="col-md-12 col-lg-9">

		<div class="card-box invisible">
			<h4 class="header-title m-t-0 m-b-20">Reviewsheet</h4>
			<div class="progress"  style="height: 20px;">
  				<div class="progress-bar bg-success" role="progressbar" style="height: 20px; width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
			</div>
			<input hidden type="text" id="save_attempt_url" value="{% url 'student:save_reviewsheet' course.id%}">
			<div class="card ">
				<div class='rs-container card-body start'>
					<h1 class="card-title">INSTRUCTIONS</h1>
					<p class="card-text">For each expression you selected, you will be shown either a correct or incorrect formulation. You will have <strong>ten seconds</strong> per expression to provide your answer. If you do not know the answer to a question, select 'skip' to move to the next. Your results will be saved after every answer, so you may end the review at any point.</p>
				</div>

				<div class='rs-container card-body show-expression'>
					<h1 class="card-title text-center" id='timedisplay' class="card-title">00.0</h1>
					<h1 id='expression-term'  class="card-title text-center">Expression</h1>
				</div>

				<div class='rs-container card-body continue'>
					<h1 class="card-title">Would you like to continue?</h1>
					<p class="card-text">Your results up to this point are automatically saved. Select <strong>EXIT</strong> to quit the review and see your results, or <strong>CONTINUE</strong> to review the next term.</p>
				</div>

				<div class='card-body end'>
					<h1 class="card-title">Review complete!</h1>
                    <table id="results_table" class="table table-hover">
                        <thead>
                            <tr>
                                <th>Original Incorrect Expression</th> <!--displays original expression-->
                                <th>Expression Shown</th> <!--display term that students saw in question-->
                                <th>Right Answer</th> <!--displays if term is gramatically correct-->
                                <th>Was Your Answer Correct</th> <!--displays if the student's answer was correct-->
                            
                            </tr>
                        </thead>
                        <tbody id="result_body">
                            

                        </tbody>

                    </table>
                    
				</div>
				<div class="btn-group d-flex card-footer" role="group" aria-label="...">
					<button class='btn btn-success btn-lg w-100 start' id='begin-review'>BEGIN REVIEW</button>

					<button class="btn btn-primary btn-lg review-response w-100 show-expression" value="correct">CORRECT</button>
					<button class="btn btn-warning btn-lg review-response w-100 show-expression" value="skipped">SKIP</button>
					<button class="btn btn-danger btn-lg review-response w-100 show-expression" value="incorrect">INCORRECT</button>
					
					<button class="btn btn-danger btn-lg continue-response w-100 continue" value="quit">EXIT REVIEW</button>
					<button class="btn btn-primary btn-lg continue-response w-100 continue" value="next-expression">CONTINUE REVIEW</button>

					<a class="btn btn-success btn-lg w-100 end" id='exit-review' href="{% url 'student:course' course.id%}">RETURN TO COURSE</a>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	// I need to move all of this into the static file - AF
	$('.rs-container').css("height", "auto");
	setEqualHeight($('.rs-container'));

	hide('show-expression');
	hide('continue');
	hide('end');

	$('.card-box').removeClass("invisible");

	const MAX_TIME = 1000.0;

	let review_data = {{ review_data | safe }};
	shuffle(review_data);
	let student = "{{ student_id | safe }}";
	let course = "{{ course.id| safe }}";
	let current_container_id = 'start';
	let start_time;
	let timer;
	let current_time = 0;
	let current_question; // variable for number of questions a user gets through
	let increments = [];
	get_bar_increments();

	function get_bar_increments() {
		let inc = 100 / review_data.length;
		let prog = 0;
		for (let j = 0; j < review_data.length - 1; j++) {
			prog += inc;
			increments.push(prog);
		}
		increments.push(100);
	}

	function hide(classname) {
		$('.' + classname).addClass("d-none");
	}

	function show(classname) {
		$('.' + classname).removeClass("d-none");
	}

	function setEqualHeight(columns) {
		var tallestcolumn = 0;
		columns.each(function() {
			currentHeight = $(this).height();
			if (currentHeight > tallestcolumn) {
				tallestcolumn = currentHeight;
			}
		});
		columns.height(tallestcolumn);
	}

	function start_time_interval () {
		set_start_time();
		timer = setInterval(update_timer, 100);
	}
	
	function update_timer() {
		update_current_time();
		$("#timedisplay").html(pad2(current_time.toFixed(1)));
		if (current_time >= MAX_TIME) {
			clearInterval(timer);
			post_max_time_exceeded(null);
			current_time = 0;
			// go to continue screen
			process_response();
		} 
	}

	function pad2(number) {
     return (number < 10 ? '0' : '') + number;
   	}

	function set_start_time() {
		start_time = getnow();
	}

	function getnow() {
		return new Date().getTime();
	}

	function update_current_time() {
		current_time = (getnow() - start_time) / 1000;
	}	

	function shuffle(array) {
  		array.sort(() => Math.random() - 0.5);
	}

	function change_container(new_container_id) {
		hide(current_container_id);
		show(new_container_id);
		current_container_id = new_container_id;
	};

	function start_review() {
		i = 0;
		// Show the first expression
		console.log(review_data);
		$("#expression-term").html(review_data[i]['term']);
		change_container("show-expression");
		start_time_interval();
	}
    
    // This function displays student results
    function display_results() {
       
        for(i = 0; i < current_question; i++){ // displays original incorrect expression and term
            if (review_data[i]['correct'] === true){ // checks if student is correct
                // displays correct is student is correct
                $("#result_body").append(`<tr><td>${review_data[i]['original']}</td><td>${review_data[i]['term']}</td><td>${review_data[i]['answer']}</td><td>Correct</td></tr>`);
            } else {
                // displays incorrect if student is incorrect
                $("#result_body").append(`<tr><td>${review_data[i]['original']}</td><td>${review_data[i]['term']}</td><td>${review_data[i]['answer']}</td><td>Incorrect</td></tr>`);
            }
        
        }

    }

	function post_max_time_exceeded(event) {
		clearInterval(timer);
		let attemptFormData = new FormData();
        review_data[i]['correct'] = false;
		attemptFormData.append( 'correct', false );
		attemptFormData.append( 'student', student );
		attemptFormData.append( 'expression', review_data[i]['id']);
		attemptFormData.append( 'response_time', MAX_TIME );
		attemptFormData.append( 'course', course);
        
		$.ajax({
			type: "POST",
			url: $("#save_attempt_url").val(),
			data: attemptFormData,
			processData: false,
			contentType: false,
			success: function(response){
				
				cs_notification('warning', "Maximum time exceeded!");
				
			},
			error: function(jqXHR, textStatus, errorThrown){
				cs_ajax_error(jqXHR, textStatus, errorThrown);
			},
		}); 
	}

	function post_response(event, time, response_value) {
		console.log(time);
		event.preventDefault();
		let attemptFormData = new FormData();
		let is_correct = (response_value == review_data[i]['answer']);
		review_data[i]['correct'] = is_correct;
        

		attemptFormData.append( 'correct', is_correct );
		attemptFormData.append( 'student', student );
		attemptFormData.append( 'expression', review_data[i]['id']);
		attemptFormData.append( 'response_time', time );
		attemptFormData.append( 'course', course);

		$.ajax({
			type: "POST",
			url: $("#save_attempt_url").val(),
			data: attemptFormData,
			processData: false,
			contentType: false,
			success: function(response){
				// REMOVE THIS FOR REAL VERSION
				cs_notification('success', "(debug) Review Attempt Recorded");
				
			},
			error: function(jqXHR, textStatus, errorThrown){
				cs_ajax_error(jqXHR, textStatus, errorThrown);
			},
		}); 
	}

	function process_response() {
		$('.progress-bar').attr('aria-valuenow', increments[i]).css('width', increments[i] + "%");
		if (increments[i] === 100) {
			$('.progress-bar').removeClass("bg-success");
			$('.progress-bar').addClass("bg-primary");
		}
		i++;
		if (i >= review_data.length) {
			// If there are no more expressions, go to end
			change_container("end");
            display_results();
		} else {
			// Allow user to go on
			change_container("continue");
		}
	}

	$( document ).ready(function() {
        console.log( "document loaded" );
	
		$("#begin-review").click( function() {
		    current_question = 1;
			start_review();
		});

		$(".review-response").mousedown( function(e) {
			clearInterval(timer);
			post_response(e, current_time, this.value);
			current_time = 0;
			// go to continue screen
			process_response();
		});

		$(".continue-response").click( function() {
			if (this.value === "quit") {
			    display_results();
				change_container("end");
			} else if (this.value === "next-expression") {
				$("#expression-term").html(review_data[i]['term']);
				current_question += 1;
				change_container("show-expression");
				start_time_interval();
			}
		}); 

    });
	
	

</script>
{% endblock %}

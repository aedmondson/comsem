<!-- Page for Speaking Practice Problems-->

{% extends 'ComSemApp/sidebar.html' %}

{% load static %}

{% block content %}

<div class="row h-100">
  <div class="col-12 h-100">
    <!-- invisible until setup is complete -->
    <div class="card-box invisible">
      <h4 class="header-title m-t-0 m-b-20">Speaking Practice</h4>
      <!-- bar displaying student's progress throughout the reviewsheet -->
        <div class="progress-bar bg-success" role="progressbar" style="height: 20px; width: 100%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        <input hidden type="text" id="transcribe_url" value="{% url 'transcribe_audio' %}">
        <div class="card">

          {% comment %}           
          <!-- sec: only shown one at a time, allowing user to navigate start > show-expression > continue > ... > end -->
          <div class='sec card-body start'> <!--card for initial instructions-->
            <h1 class="card-title">INSTRUCTIONS</h1>
            <p class="card-text">For each expression you selected, you will be shown either a <strong>RIGHT</strong> or <strong>WRONG</strong> formulation. You will have <strong>10 SECONDS</strong> per expression to provide your answer. If you do not know the answer to a question, select <strong>SKIP</strong> to move to the next. Your results will be saved after every answer, so you may end the review at any point.</p>
          </div>
          {% endcomment %}
  
          <div class="sec ec card-body show-expression inline-block  text-center align-middle" id="expression-container"> <!-- card for showing expression -->
            <h1 id='expression-text' class="card-title text-center show-expression"></h1>
            <h2 id="timer-text" class="show-expression"></h2>
            <div class="timer bg-muted" style="height: 100px; width: 100%">
              <div id="timer-bar" class="timer-bar bg-info show-expression" role="timer" style="height: 100px; width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <br>
          </div>

          {% comment %}   
          <div class='sec ec card-body continue'> <!-- card that asks students if they would like to quit mid review sheet or continue-->
            <h1 class="card-title">CONTINUE?</h1>
            <p class="card-text">Your results up to this point are automatically saved. Select <strong>EXIT</strong> to quit the review and see your results, or <strong>CONTINUE</strong> to review the next term.</p>
          </div>
          {% endcomment %}

          {% comment %} 
          <div class='card-body d-none end'> <!--card for displaying results-->
            <h1 class="card-title">Review complete!</h1>
              <table id="results_table" class="table table-hover"> <!--table for displaying results of a worksheet-->
                  <thead>
                      <tr>
                          <th>Expression Shown</th> <!--display term that students saw in question-->
                          <th class="text-center">Correct Response</th> <!--displays if term is gramatically correct-->
                          <th class="text-center">Result</th> <!--displays if the student's answer was correct-->
                      </tr>
                  </thead>
                  <tbody id="result_body">
                      <!-- Results populated here -->
                  </tbody>
              </table>
          </div>
          {% endcomment %}


          <div class="btn-group d-flex card-footer" role="group" aria-label="...">
            
            <!-- button display cycles same as secs -->
            <button class='btn btn-success btn-lg sec w-100 start' id='begin-review'>BEGIN REVIEW</button>
            
            {% comment %}
            <button class="btn btn-disabled btn-lg sec ec w-100 play-audio" value="right">RIGHT</button>
            <button class="btn btn-disabled btn-lg sec ec w-100 play-audio" value="skipped">SKIP</button>
            <button class="btn btn-disabled btn-lg sec ec w-100 play-audio" value="wrong">WRONG</button>
            
            <button class="btn btn-primary btn-lg sec ec review-response w-100 show-expression" value="right">RIGHT</button>
            <button class="btn btn-warning btn-lg sec ec review-response w-100 show-expression" value="skipped">SKIP</button>
            <button class="btn btn-danger btn-lg sec ec review-response w-100 show-expression" value="wrong">WRONG</button>
            
            <button class="btn btn-danger btn-lg sec ec continue-response w-100 continue" value="quit">EXIT REVIEW</button>
            <button class="btn btn-primary btn-lg sec ec continue-response w-100 continue" value="next-expression">CONTINUE REVIEW</button>
            {% endcomment %}
            
            <button class="btn btn-success btn-lg sec ec w-100 control" value="stop">STOP RECORDING</button>
            <button class="btn btn-success btn-lg sec ec w-100 control" value="next">NEXT EXPRESSION</button>
          </div>
        </div>
        <button class="btn btn-warning btn-lg w-100 m-1" onclick="window.location.href='{% url 'student:speaking_practice_results' course.id %}';">RESULTS</button>
        <button class="btn btn-warning btn-lg w-100 m-1" onclick="window.location.href='{% url 'student:course' course.id %}';">RETURN TO COURSE</button>
      </div>
    </div>
  </div>
</div>

{% comment %} 
<!-- recordmp3 needed by ComSemRecording -->
<script src="{% static "ComSemApp/js/opus-recorder/dist/recorder.min.js" %}"></script>
<script src="{% static "ComSemApp/js/ComSemRecording-opus.js" %}?{% now "U" %}"></script>

<input hidden type="text" id="create_or_update_url">

<!-- original -->
{% if worksheet.display_original %}
<div class="row">
    <div class="col-12">
        <label>Original Expression:</label>
        <p id="ExprToEdit">{{ expression.expression }}</p>
    </div>
</div>
{% endif %}

<!-- AUDIO RECORDING -->
<div class="row" id="display_reformulation_audioRow">
    {% include 'ComSemApp/student/assessment_audio_recording.html' %}
    <script>
        var encoderPath = "{% static 'ComSemApp/js/opus-recorder/dist/encoderWorker.min.js' %}"; // used in ComSemRecording
        initializeRecorder() // from encoderPath, initializes recording device
        // Audio currently not being recorded
    </script>
</div>
{% endcomment %}

{% comment %} 
<div class="row">
    <div class="col-12 text-center">
        <div class="btn-group" role="group">
            <button type="button" id="saveAttempt" class="btn btn-outline-success">Finished Recording</button>
        </div>
    </div>
</div>
 {% endcomment %}


<!-- Button script for finishing recording. Will need to be changed to call when disabled-->
<script>
const READING_OFFSET = 2;
const RECORDING_OFFSET = 3;
// Change this to desired expression
let sentence = 'This an example.'; 

function timer(syllables, offset) {
  return new Promise((resolve, reject) => {
    let start_time = getnow();
    let current_time = 0;
    let max_time = offset + syllables / 3
    $("#timer-bar").attr("aria-valuenow", 0).css("width", 0 + "%");
    $("#timer-bar").visibility = "visible";
    $("#timer-text").visibility = "visible";

    //timer function tics every .1secs
    let update = setInterval(() => {
      current_time = (getnow() - start_time) / 1000;
      // This runs when the timer is complete
      if(current_time >= max_time){ 
        clearInterval(update);
        resolve();
      }
      let value = Math.min(((current_time / max_time) * 100), 100);
      $("#timer-bar").attr("aria-valuenow", value)
        .css("width", value + "%");
      $("#timer-text").html(current_time.toFixed(0));
    }, 25);
  });
}

function hide(classname) {
  $('.' + classname).addClass("d-none");
}

function show(classname) {
  $('.' + classname).removeClass("d-none");
}

function setEqualHeight(classgroup) {
  $('.card-box').addClass("invisible");
  show(classgroup);
  $("div." + classgroup).height("auto");

  var tallestcolumn = 0;
  $("div." + classgroup).each(function() {
    currentHeight = $(this).height();
    if (currentHeight > tallestcolumn) {
      tallestcolumn = currentHeight;
    }
  });
  $("div." + classgroup).height(tallestcolumn);

  hide(classgroup)
  //show(current_container_id);
  $('.card-box').removeClass("invisible");
}

function pad2(number) {
  return (number < 10 ? '0' : '') + number;
 }

// AF - return the current time
function getnow() {
return new Date().getTime();
}

$(document).ready(() => {
  console.log( "document loaded" );

  $(window).on("beforeunload", (event) => {
    event.preventDefault();
    // This text won't show in modern browsers :(
    event.returnValue = 'WARNING: If you leave this page, you will not be able to continue the review where you left off. Exit anyway?';
    return event.returnValue;
  });

  // initializing review
  $("#begin-review").click(() => {
      current_question = 1;
    start_review();
  });

  /*
  // get responses and stop the timer
  $(".review-response").mousedown((e) => {
    clearInterval(timer);
    post_response(e, current_time, this.value);
    current_time = 0;
    // go to continue screen
    process_response();
  });
  */

  $(".control").click(() => {
    // TODO: add logic to submit attempt
    if(this.value == "stop") {

    }
  });

  /*
  // direct to appropriate sec based on continue response
  $(".continue-response").click(() => {
    if (this.value === "quit") {
        display_results();
      change_container("end");
      $(window).off("beforeunload");
    } else if (this.value === "next-expression") {
      set_display(review_data[i])
      current_question += 1;
    }
  }); 
  */

  $(window).resize(() => {
    /*
    if (current_container_id == 'start') {
      setEqualHeight('sec');
    } else if (current_container_id != 'end') {
      setEqualHeight('ec');
    }
    */
    setEqualHeight("sec");
    show("show-expression");
    show("control");
  });

$("#expression-text").html(sentence);
$("#timer-bar").visibility = "hidden";
$("#timer-text").visibility = "hidden";

show("show-expression");

setEqualHeight("sec");

//runs the reading timer
let reading_check = timer(sentence.length/2, READING_OFFSET);
//Once reading timer done this starts
reading_check.then(() => {
  $("#timer-bar").removeClass("bg-info").addClass("bg-danger")
  //This is where recording start goes
  //Runs the recording timer
  let recording_check = timer(sentence.length/2, RECORDING_OFFSET);
  //Once recording timer done this starts
  recording_check.then(() => { 
    //This is where recording stop goes
    //This was a last test can be deleted
    $("#expression-text").html('Problem Complete!');
  });
});
});
</script>

{% endblock %}